{% extends "base.html" %}

{% block title %}Dashboard - Fortress{% endblock %}

{% block content %}
<div class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>Welcome, <span class="text-neon">{{ user.username }}</span></h1>
        </div>
        <div class="system-status">
            <span class="pulse-dot"></span>
            <span>System Online</span>
        </div>
    </div>

    <!-- Bento Grid Layout -->
    <div class="bento-grid">

        <!-- Artifact Uploads - Large Card -->
        <div class="glass-card bento-span-8">
            <div class="glass-card-title">
                <span>üì¶</span>
                <span>Artifact Vault</span>
            </div>

            {% if artifacts %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>SHA-256 Hash</th>
                        <th>Status</th>
                        <th>Uploaded</th>
                        {% if user.role.value == 'manager' %}
                        <th>Action</th>
                        {% endif %}
                        <th>QR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for artifact in artifacts %}
                    <tr>
                        <td>{{ artifact.filename }}</td>
                        <td>
                            <span class="hash-text">{{ artifact.file_hash[:8] }}...{{ artifact.file_hash[-8:] }}</span>
                        </td>
                        <td>
                            {% if artifact.status.value == 'approved' %}
                            <span class="badge badge-approved">
                                <span class="pulse-dot" style="width: 6px; height: 6px;"></span>
                                Verified
                            </span>
                            {% elif artifact.status.value == 'rejected' %}
                            <span class="badge badge-rejected">‚úï Rejected</span>
                            {% else %}
                            <span class="badge badge-pending">‚óê Pending</span>
                            {% endif %}
                        </td>
                        <td class="text-muted" style="font-size: 0.8rem;">
                            <span class="utc-time" data-timestamp="{{ artifact.uploaded_at.isoformat() }}"
                                data-format="datetime">
                                {{ artifact.uploaded_at.strftime('%Y-%m-%d %H:%M') }} UTC
                            </span>
                        </td>
                        {% if user.role.value == 'manager' %}
                        <td>
                            {% if artifact.status.value == 'pending' %}
                            <form method="POST" action="/approve/{{ artifact.id }}" style="display: inline;">
                                <button type="submit" class="btn btn-success btn-sm">Approve</button>
                            </form>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            <a href="/qr/{{ artifact.id }}" target="_blank" class="btn btn-ghost btn-sm">
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center text-muted" style="padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p>No artifacts in the vault yet.</p>
                <p style="font-size: 0.85rem;">Upload your first artifact using the CLI tool.</p>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Stats & Logs -->
        <div class="bento-span-4 flex flex-col gap-md">

            <!-- Quick Stats -->
            <div class="glass-card">
                <div class="glass-card-title">
                    <span>üìä</span>
                    <span>Quick Stats</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 600; color: var(--neon-cyan);">
                            {{ artifacts|length if artifacts else 0 }}
                        </div>
                        <div class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Total Artifacts
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 600; color: var(--neon-green);">
                            {{ artifacts|selectattr('status.value', 'equalto', 'approved')|list|length if artifacts else
                            0 }}
                        </div>
                        <div class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Verified</div>
                    </div>
                </div>
            </div>

            <!-- Audit Log Terminal -->
            <div class="glass-card" style="flex: 1;">
                <div class="glass-card-title">
                    <span>üñ•Ô∏è</span>
                    <span>Audit Log</span>
                </div>
                <div class="terminal">
                    {% if artifacts %}
                    {% for artifact in artifacts[:5] %}
                    <div class="terminal-line">
                        <span class="terminal-time utc-time" data-timestamp="{{ artifact.uploaded_at.isoformat() }}"
                            data-format="time">[{{ artifact.uploaded_at.strftime('%H:%M') }}]</span>
                        <span class="terminal-event">UPLOAD: {{ artifact.filename }}</span>
                    </div>
                    {% if artifact.status.value == 'approved' %}
                    <div class="terminal-line">
                        <span class="terminal-time utc-time"
                            data-timestamp="{{ artifact.approved_at.isoformat() if artifact.approved_at else '' }}"
                            data-format="time">[{{ artifact.approved_at.strftime('%H:%M') if artifact.approved_at else
                            '--:--' }}]</span>
                        <span class="terminal-event" style="color: var(--neon-green);">VERIFY: {{ artifact.filename
                            }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="terminal-line">
                        <span class="terminal-time">[--:--]</span>
                        <span class="terminal-event">Awaiting events...</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    document.querySelectorAll('.utc-time').forEach(function (el) {
                        const timestamp = el.getAttribute('data-timestamp');
                        const format = el.getAttribute('data-format');
                        if (!timestamp) return;

                        const date = new Date(timestamp + (timestamp.endsWith('Z') ? '' : 'Z')); // Ensure UTC treatment

                        if (format === 'time') {
                            // Format: [HH:MM]
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            el.innerText = `[${hours}:${minutes}]`;
                        } else {
                            // Format: YYYY-MM-DD HH:MM
                            const year = date.getFullYear();
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const day = date.getDate().toString().padStart(2, '0');
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            el.innerText = `${year}-${month}-${day} ${hours}:${minutes}`;
                        }
                    });
                });
            </script>

        </div>
    </div>

    <!-- CLI Usage Hint -->
    <!-- Inactive Users (Manager Only) -->
    {% if user.role.value == 'manager' and inactive_users %}
    <div class="glass-card mt-lg">
        <div class="glass-card-title">
            <span>üë•</span>
            <span>Pending User Approvals</span>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Registered</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inactive_user in inactive_users %}
                    <tr>
                        <td>{{ inactive_user.username }}</td>
                        <td><span class="role-badge">{{ inactive_user.role.value }}</span></td>
                        <td class="text-muted" style="font-size: 0.8rem;">
                            <span class="utc-time" data-timestamp="{{ inactive_user.created_at.isoformat() }}"
                                data-format="datetime">
                                {{ inactive_user.created_at.strftime('%Y-%m-%d %H:%M') }} UTC
                            </span>
                        </td>
                        <td>
                            <form action="/approve-user/{{ inactive_user.id }}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-success btn-sm">
                                    Approve
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Developer Tools -->
    {% if user.role.value == 'developer' %}
    <div class="glass-card mt-lg">
        <div class="glass-card-title">
            <span>üíª</span>
            <span>Developer CLI</span>
        </div>
        <div class="terminal" style="max-height: 80px;">
            <div class="terminal-line">
                <span style="color: var(--neon-purple);">$</span>
                <span class="font-mono" style="color: var(--text-primary);">python client_upload.py &lt;file&gt;
                    keys/dev_private.pem</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}